# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞ Sport_apteka_bot

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- yookassa>=3.0.0 (–¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π)
- fastapi>=0.100.0 (–¥–ª—è webhook API)
- uvicorn>=0.23.0 (–¥–ª—è –∑–∞–ø—É—Å–∫–∞ API —Å–µ—Ä–≤–µ—Ä–∞)

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ü–í–ó** (callback `use_pvz:`)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```powershell
pip install -r requirements.txt
```

## –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```powershell
python bot.py
```

‚ö†Ô∏è –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –ø–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç, —Ç–∞–∫ –∫–∞–∫ YooKassa –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å webhook –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)

–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π –Ω—É–∂–µ–Ω **–ø—É–±–ª–∏—á–Ω—ã–π URL** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook –æ—Ç YooKassa.

#### –û–ø—Ü–∏—è –ê: –ò—Å–ø–æ–ª—å–∑—É—è ngrok (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

1. –°–∫–∞—á–∞–π—Ç–µ [ngrok](https://ngrok.com/download)

2. –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä:
```powershell
uvicorn api:app --host 0.0.0.0 --port 8000
```

3. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ngrok:
```powershell
ngrok http 8000
```

4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –≤–∏–¥–∞ `https://xxxx-xxx-xxx-xxx.ngrok-free.app`

5. –í –ø–∞–Ω–µ–ª–∏ YooKassa –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook:
   - URL: `https://xxxx-xxx-xxx-xxx.ngrok-free.app/yookassa/webhook`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`

6. –í —Ç—Ä–µ—Ç—å–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```powershell
python bot.py
```

#### –û–ø—Ü–∏—è –ë: –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ

1. –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –ø—É–±–ª–∏—á–Ω—ã–º IP –∏–ª–∏ –¥–æ–º–µ–Ω–æ–º

2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ nginx/Apache –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API:
```nginx
location /yookassa/webhook {
    proxy_pass http://localhost:8000/yookassa/webhook;
}
```

3. –í –ø–∞–Ω–µ–ª–∏ YooKassa –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook:
   - URL: `https://–≤–∞—à-–¥–æ–º–µ–Ω.com/yookassa/webhook`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ systemd –∏–ª–∏ supervisor):
```powershell
uvicorn api:app --host 127.0.0.1 --port 8000
```

5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```powershell
python bot.py
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

1. **–í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞** ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "üí≥ –ó–∞–∫–∞–∑–∞—Ç—å" –∏–ª–∏ "üõí –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã

2. **–í–≤–æ–¥ –ø—Ä–æ—Ñ–∏–ª—è** (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑):
   - –ò–º—è
   - –§–∞–º–∏–ª–∏—è
   - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

3. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è** ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

4. **–í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏**:
   - üöö –Ø–Ω–¥–µ–∫—Å
   - üöõ –°–î–≠–ö
   - üì¶ –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏

5. **–í—ã–±–æ—Ä/–≤–≤–æ–¥ –ü–í–ó** ‚Üí –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏

6. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞** ‚Üí –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç pending_order

7. **–û–ø–ª–∞—Ç–∞** ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É YooKassa

8. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã** ‚Üí –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:
   - Webhook –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç YooKassa
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ –≤ orders.json
   - –°–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞
   - –û—á–∏—â–∞–µ—Ç—Å—è –∫–æ—Ä–∑–∏–Ω–∞ (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã)
   - –£–¥–∞–ª—è–µ—Ç—Å—è pending_order
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

### –î–ª—è –∞–¥–º–∏–Ω–∞:

–ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
- ‚úÖ –û –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
- ‚ö†Ô∏è –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è (‚â§3 —à—Ç)
- ‚õî –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–æ–Ω—á–∏–ª—Å—è

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ

1. –í–æ–π–¥–∏—Ç–µ –Ω–∞ [yookassa.ru](https://yookassa.ru)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
3. –î–æ–±–∞–≤—å—Ç–µ **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
   - URL: `https://–≤–∞—à-–ø—É–±–ª–∏—á–Ω—ã–π-url/yookassa/webhook`
   - –ú–µ—Ç–æ–¥: POST
   - –°–æ–±—ã—Ç–∏—è: –û—Ç–º–µ—Ç—å—Ç–µ `payment.succeeded`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env —Ñ–∞–π–ª:
```env
TOKEN=7850333677:AAEJDBlB9BBZKtkXNYJvBGUaOQ4o5kr6bn0
YOOKASSA_SHOP_ID=1214965
YOOKASSA_SECRET_KEY=live_EwDgsTZ7Fkvtn-FqJZqmkFZFbH3X1AysHfRSTH4es00
BOT_USERNAME=Sport_apteka_bot
YOOKASSA_RETURN_URL=https://t.me/Sport_apteka_bot
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö:
–í—Å–µ JSON —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ `data/` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º–∏

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–≤–∞—Ä—ã:
- –í –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `stock > 0`
- –¶–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –≤ –ø–∞–Ω–µ–ª–∏ YooKassa
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –ø—É–±–ª–∏—á–Ω—ã–π (–Ω–µ localhost)

### –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ —Ç–æ–≤–∞—Ä –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –≤ YooKassa
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ api.py
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ payment.succeeded –ø—Ä–∏—Ö–æ–¥–∏—Ç

### –ö–æ—Ä–∑–∏–Ω–∞ –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ "type" –≤ pending_order (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "cart")
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ TOKEN –≤ .env –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:
1. –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤—ã–∑–æ–≤ `create_yookassa_payment()` –≤ `finalize_order()`
2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞–ø—Ä—è–º—É—é –≤–º–µ—Å—Ç–æ pending
3. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É

### –° —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏:
1. –í –ø–∞–Ω–µ–ª–∏ YooKassa –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã: `5555 5555 5555 4444`
3. –õ—é–±–æ–π —Å—Ä–æ–∫, CVC –∏ –∏–º—è

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö

```
data/
‚îú‚îÄ‚îÄ addresses.json      # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞/–ü–í–ó –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ admins.json        # ID –∞–¥–º–∏–Ω–æ–≤
‚îú‚îÄ‚îÄ carts.json         # –ö–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ categories.json    # –ö–∞—Ç–∞–ª–æ–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤
‚îú‚îÄ‚îÄ favs.json         # –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ orders.json       # –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
‚îú‚îÄ‚îÄ pending_orders.json # –û–∂–∏–¥–∞—é—â–∏–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑—ã
‚îú‚îÄ‚îÄ products.json     # –¢–æ–≤–∞—Ä—ã
‚îú‚îÄ‚îÄ profiles.json     # –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —Ç–µ–ª–µ—Ñ–æ–Ω)
‚îî‚îÄ‚îÄ users.json        # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å:
- –õ–æ–≥–∏ –±–æ—Ç–∞ (python bot.py > bot.log 2>&1)
- –õ–æ–≥–∏ API (uvicorn api:app --log-level info)
- –†–∞–∑–º–µ—Ä pending_orders.json (–Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
- Webhook —Å—Ç–∞—Ç—É—Å –≤ –ø–∞–Ω–µ–ª–∏ YooKassa

## Backup

–†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ backup –ø–∞–ø–∫–∏ `data/`:
```powershell
$date = Get-Date -Format "yyyy-MM-dd_HHmmss"
Copy-Item -Path "data" -Destination "backups/data_$date" -Recurse
```
